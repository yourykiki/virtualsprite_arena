pico-8 cartridge // http://www.pico-8.com
version 35
__lua__
local vsprtbl,vsprq,hit,tot=
 {},{},0,0

function draw_vspr(nspr,x,y)
 local nxtspr
 --nspr in cache ?
 if vsprtbl[nspr]!=nil then
  --yes update age queue
  del(vsprq,nspr)
  add(vsprq,nspr)
  nxtspr=vsprtbl[nspr]
  hit+=1
--debug  ?"update age queue"
 else
  nxtspr=#vsprq
	 --if vsprq full(cache length)
	 if nxtspr==16 then
	  --remove first
	  local o=deli(vsprq,1)
	  nxtspr=vsprtbl[o]
	  vsprtbl[o]=nil
--debug   ?"remove first"
	 end
  add(vsprq,nspr)
  vsprtbl[nspr]=nxtspr
--debug  ?"add last"
  --copy 
  local dst,src=
   0x0000+(nxtspr\16)*512+nxtspr%16*4,
   0x1000+(nspr\16)*512+nspr%16*4
  for i=0,7 do
   memcpy(dst+i*64,src+i*64,4)
  end
 end
 --draw spr
 spr(nxtspr,x,y)
end

function tbl2str(tbl)
 local res=""
 for x in all(tbl) do
  res=res..x..","
 end
 return res
end
function tbl2strpair(tbl)
 local res=""
 for i=0,7 do
 local val=tbl[i] or ""
  res=res..i.."="..val..","
 end
 return res
end
function wait_btn()
 repeat until btnp(‚ùé)
end


--function _draw()
 cls()
 local ctime,nbspr=stat(1),32767
 for i=1,nbspr do
  local nb=rnd(64)\1
  local x=rnd(121)\1
  local y=rnd(56)\1
  draw_vspr(nb,x,y)
  tot+=1
 end
 ctime=stat(1)-ctime
 spr(0,0,64,16,4)
 spr(128,0,96,16,4)
-- wait_btn()
 print("ratio "..(hit/tot)..
  " time "..(ctime/30),0,81,7)
 print("vspr/sec "..nbspr/(ctime/30))
-- rectfill(0,73,127,96,0)
-- print("adding "..s,0,73,7)
-- print("q "..tbl2str(vsprq))
-- print("c "..tbl2strpair(vsprtbl))
-- rectfill(0,64,0,64,7)
--end

__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
f11111fff22222fffff11ffffff22fffff1111ffff2222ffff1111ffff2222fffff111fffff222fff111111ff222222fff1111ffff2222fff111111ff222222f
11fff11f22fff22fff111fffff222ffff11ff11ff22ff22ff11ff11ff22ff22fff1111ffff2222fff11fff1ff22fff2ff11ff11ff22ff22ff11ff11ff22ff22f
11ff111f22ff222ffff11ffffff22ffffffff11ffffff22ffffff11ffffff22ff11f11fff22f22fff11ffffff22ffffff11ffffff22ffffffffff11ffffff22f
11f1f11f22f2f22ffff11ffffff22fffff1111ffff2222fffff111fffff222ff11ff11ff22ff22fff11111fff22222fff11111fff22222ffffff11ffffff22ff
111ff11f222ff22ffff11ffffff22ffff11ffffff22ffffffffff11ffffff22f1111111f2222222ffffff11ffffff22ff11ff11ff22ff22ffff11ffffff22fff
11fff11f22fff22ffff11ffffff22ffff11ff11ff22ff22ff11ff11ff22ff22fffff11ffffff22fff11ff11ff22ff22ff11ff11ff22ff22ffff11ffffff22fff
f11111fff22222fff111111ff222222ff111111ff222222fff1111ffff2222fffff1111ffff2222fff1111ffff2222ffff1111ffff2222fffff11ffffff22fff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
f33333fff44444fffff33ffffff44fffff3333ffff4444ffff3333ffff4444fffff333fffff444fff333333ff444444fff3333ffff4444fff333333ff444444f
33fff33f44fff44fff333fffff444ffff33ff33ff44ff44ff33ff33ff44ff44fff3333ffff4444fff33fff3ff44fff4ff33ff33ff44ff44ff33ff33ff44ff44f
33ff333f44ff444ffff33ffffff44ffffffff33ffffff44ffffff33ffffff44ff33f33fff44f44fff33ffffff44ffffff33ffffff44ffffffffff33ffffff44f
33f3f33f44f4f44ffff33ffffff44fffff3333ffff4444fffff333fffff444ff33ff33ff44ff44fff33333fff44444fff33333fff44444ffffff33ffffff44ff
333ff33f444ff44ffff33ffffff44ffff33ffffff44ffffffffff33ffffff44f3333333f4444444ffffff33ffffff44ff33ff33ff44ff44ffff33ffffff44fff
33fff33f44fff44ffff33ffffff44ffff33ff33ff44ff44ff33ff33ff44ff44fffff33ffffff44fff33ff33ff44ff44ff33ff33ff44ff44ffff33ffffff44fff
f33333fff44444fff333333ff444444ff333333ff444444fff3333ffff4444fffff3333ffff4444fff3333ffff4444ffff3333ffff4444fffff33ffffff44fff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ff1111ffff2222ffff1111ffff2222fffff11ffffff22fff111111ff222222ffff1111ffff2222ff11111fff22222fff1111111f2222222f1111111f2222222f
f11ff11ff22ff22ff11ff11ff22ff22fff1111ffff2222fff11ff11ff22ff22ff11ff11ff22ff22ff11f11fff22f22fff11fff1ff22fff2ff11fff1ff22fff2f
f11ff11ff22ff22ff11ff11ff22ff22ff11ff11ff22ff22ff11ff11ff22ff22f11ffffff22fffffff11ff11ff22ff22ff11ffffff22ffffff11f1ffff22f2fff
ff1111ffff2222ffff11111fff22222ff11ff11ff22ff22ff11111fff22222ff11ffffff22fffffff11ff11ff22ff22ff1111ffff2222ffff1111ffff2222fff
f11ff11ff22ff22ffffff11ffffff22ff111111ff222222ff11ff11ff22ff22f11ffffff22fffffff11ff11ff22ff22ff11ffffff22ffffff11f1ffff22f2fff
f11ff11ff22ff22ff11ff11ff22ff22ff11ff11ff22ff22ff11ff11ff22ff22ff11ff11ff22ff22ff11f11fff22f22fff11fff1ff22fff2ff11ffffff22fffff
ff1111ffff2222ffff1111ffff2222fff11ff11ff22ff22f111111ff222222ffff1111ffff2222ff11111fff22222fff1111111f2222222f1111ffff2222ffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
ff3333ffff4444ffff3333ffff4444fffff33ffffff44fff333333ff444444ffff3333ffff4444ff33333fff44444fff3333333f4444444f3333333f4444444f
f33ff33ff44ff44ff33ff33ff44ff44fff3333ffff4444fff33ff33ff44ff44ff33ff33ff44ff44ff33f33fff44f44fff33fff3ff44fff4ff33fff3ff44fff4f
f33ff33ff44ff44ff33ff33ff44ff44ff33ff33ff44ff44ff33ff33ff44ff44f33ffffff44fffffff33ff33ff44ff44ff33ffffff44ffffff33f3ffff44f4fff
ff3333ffff4444ffff33333fff44444ff33ff33ff44ff44ff33333fff44444ff33ffffff44fffffff33ff33ff44ff44ff3333ffff4444ffff3333ffff4444fff
f33ff33ff44ff44ffffff33ffffff44ff333333ff444444ff33ff33ff44ff44f33ffffff44fffffff33ff33ff44ff44ff33ffffff44ffffff33f3ffff44f4fff
f33ff33ff44ff44ff33ff33ff44ff44ff33ff33ff44ff44ff33ff33ff44ff44ff33ff33ff44ff44ff33f33fff44f44fff33fff3ff44fff4ff33ffffff44fffff
ff3333ffff4444ffff3333ffff4444fff33ff33ff44ff44f333333ff444444ffff3333ffff4444ff33333fff44444fff3333333f4444444f3333ffff4444ffff
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
